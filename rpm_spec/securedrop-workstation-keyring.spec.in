Name:       securedrop-workstation-keyring-staging
Version:    @VERSION@
Release:    @REL@%{?dist}
Summary:    SecureDrop Workstation Keyring (staging)

# Macros for dealing with key import and old key deletion:
#
#   * In rpm database, the pubkey name format is
#    `gpg-pubkey-$VERSION-$CREATION_SEC_SINCE_UNIX_EPOCH`, where $VERSION is the
#     last 8 characters of the GPG key's fingerprint, and $CREATIONDATE is the
#     key creation date, expressed as:
#       `date -d "1970-1-1 + $((0x$CREATION_UNIX_EPOCH)) sec`
%define previous_gpg_key gpg-pubkey-00000000-00000000
%define current_gpg_key gpg-pubkey-3fab65ab-660f2beb
#
#   * The following macros are needed because RPM key database operations cannot
#     happen in dnf<5 during an RPM package installation / uninstallation, etc.
#     The trick is to schedule them to happen after RPM finishes.
%define systemd_timer systemd-run --timer-property=AccuracySec=1s --on-active=2s timeout 15m
#
#     Import current key (NOTE: key expiry bumps may keep the same 'key name')
%define import_current_key %{systemd_timer} sh -c 'while ! rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-securedrop-workstation-test; do sleep 2; done'
%define purge_key() %{systemd_timer} sh -c 'while rpm -q %{1} && ! rpm -e %{1}; do sleep 2; done'

# For reproducible builds:
#
#   * Ensure that SOURCE_DATE_EPOCH env is honored and inherited from the
#     last changelog entry, and enforced for package content mtimes
%define source_date_epoch_from_changelog 1
%define use_source_date_epoch_as_buildtime 1
%define clamp_mtime_to_source_date_epoch 1
#   * By default, changelog entries for the last two years of the current time
#     (_not_ SOURCE_DATE_EPOCH) are included, everything else is discarded.
#     For easy reproducibility we'll keep everything
%define _changelog_trimtime 0
%define _changelog_trimage 0
#   * _buildhost varies based on environment, we build with containers but
#     ensure this is the same regardless
%global _buildhost %{name}
#   * optflags is for multi-arch support: otherwise rpmbuild sets 'OPTFLAGS: -O2 -g -march=i386 -mtune=i686'
%global optflags -O2 -g
# To ensure forward-compatibility of RPMs regardless of updates to the system
# Python, we disable the creation of bytecode at build time via the build
# root policy.
%undefine py_auto_byte_compile

License:    AGPLv3
URL:        https://github.com/freedomofpress/securedrop-workstation-keyring

BuildArch:  noarch
BuildRequires:  make
Requires:   python%{python3_pkgversion}

Source0: %{name}-%{version}.tar.gz

%description
This package contains the SecureDrop Test Key and .repo file used to bootstrap a staging installation of SecureDrop Workstation.

%prep
%setup -q

%build
# No building necessary

%install
install -m 755 -d %{buildroot}/etc/yum.repos.d
install -m 755 -d %{buildroot}/etc/pki/rpm-gpg
install -m 644 files/securedrop-workstation-dom0-staging.repo.in %{buildroot}/etc/yum.repos.d/securedrop-workstation-dom0-staging.repo
install -m 644 files/securedrop-test-key.asc %{buildroot}/etc/pki/rpm-gpg/RPM-GPG-KEY-securedrop-workstation-test

%files
/etc/pki/rpm-gpg/RPM-GPG-KEY-securedrop-workstation-test
/etc/yum.repos.d/securedrop-workstation-dom0-staging.repo

%postun
# Uninstall
if [ $1 -eq 0 ] ; then
    %{purge_key %{current_gpg_key}}
fi

%posttrans
# For versions of rpm >= 4.2.0 and rpm-sequoia >= 1.7.0, importing
# an updated key (same fingerprint, different subkeys) will successfully
# update the key, and this can be simplified to a single rpm --import
# command. But until that lands in dom0, ship this logic (in case of unexpected
# upgrade).
#
# New install
if [ $1 -eq 1 ] ; then
    %{import_current_key}
fi
# Upgrade. Uninstall old key then install new key.
if [ $1 -gt 1 ] ; then
    %{purge_key %{previous_gpg_key}}
    %{import_current_key}
fi

%changelog
@CHANGELOG@
